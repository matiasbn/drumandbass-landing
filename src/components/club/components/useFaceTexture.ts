'use client';

import { useMemo } from 'react';
import * as THREE from 'three';
import { stringHash } from 'facehash';

// SVG templates for each face type â€” use FILL_COLOR placeholder for dynamic coloring
const FACE_SVGS = [
  // RoundFace - viewBox="0 0 63 15"
  (color: string) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 63 15" fill="none">
    <path d="M62.4 7.2C62.4 11.1765 59.1765 14.4 55.2 14.4C51.2236 14.4 48 11.1765 48 7.2C48 3.22355 51.2236 0 55.2 0C59.1765 0 62.4 3.22355 62.4 7.2Z" fill="${color}"/>
    <path d="M14.4 7.2C14.4 11.1765 11.1765 14.4 7.2 14.4C3.22355 14.4 0 11.1765 0 7.2C0 3.22355 3.22355 0 7.2 0C11.1765 0 14.4 3.22355 14.4 7.2Z" fill="${color}"/>
  </svg>`,
  // CrossFace - viewBox="0 0 71 23"
  (color: string) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 23" fill="none">
    <path d="M11.5 0C12.9411 0 13.6619.000460386 14.1748.354492 14.3742.49213 14.547.664882 14.6846.864258 15.0384 1.37711 15.0391 2.09739 15.0391 3.53809V7.96094H19.4619C20.9027 7.96094 21.6229 7.9615 22.1357 8.31543 22.3352 8.45308 22.5079 8.62578 22.6455 8.8252 22.9995 9.3381 23 10.0589 23 11.5 23 12.9408 22.9995 13.661 22.6455 14.1738 22.5079 14.3733 22.3352 14.5459 22.1357 14.6836 21.6229 15.0375 20.9027 15.0381 19.4619 15.0381H15.0391V19.4619C15.0391 20.9026 15.0384 21.6229 14.6846 22.1357 14.547 22.3351 14.3742 22.5079 14.1748 22.6455 13.6619 22.9995 12.9411 23 11.5 23 10.0592 23 9.33903 22.9994 8.82617 22.6455 8.62674 22.5079 8.45309 22.3352 8.31543 22.1357 7.96175 21.6229 7.96191 20.9024 7.96191 19.4619V15.0381H3.53809C2.0973 15.0381 1.37711 15.0375.864258 14.6836.664834 14.5459.492147 14.3733.354492 14.1738.000498831 13.661-5.88036e-08 12.9408 0 11.5 6.2999e-08 10.0589.000460356 9.3381.354492 8.8252.492144 8.62578.664842 8.45308.864258 8.31543 1.37711 7.9615 2.09731 7.96094 3.53809 7.96094H7.96191V3.53809C7.96191 2.09765 7.96175 1.37709 8.31543.864258 8.45309.664828 8.62674.492149 8.82617.354492 9.33903.000555366 10.0592 1.62347e-09 11.5 0Z" fill="${color}"/>
    <path d="M58.7695 0C60.2107 0 60.9314.000460386 61.4443.354492 61.6437.49213 61.8165.664882 61.9541.864258 62.308 1.37711 62.3086 2.09739 62.3086 3.53809V7.96094H66.7314C68.1722 7.96094 68.8924 7.9615 69.4053 8.31543 69.6047 8.45308 69.7774 8.62578 69.915 8.8252 70.2691 9.3381 70.2695 10.0589 70.2695 11.5 70.2695 12.9408 70.269 13.661 69.915 14.1738 69.7774 14.3733 69.6047 14.5459 69.4053 14.6836 68.8924 15.0375 68.1722 15.0381 66.7314 15.0381H62.3086V19.4619C62.3086 20.9026 62.308 21.6229 61.9541 22.1357 61.8165 22.3351 61.6437 22.5079 61.4443 22.6455 60.9314 22.9995 60.2107 23 58.7695 23 57.3287 23 56.6086 22.9994 56.0957 22.6455 55.8963 22.5079 55.7226 22.3352 55.585 22.1357 55.2313 21.6229 55.2314 20.9024 55.2314 19.4619V15.0381H50.8076C49.3668 15.0381 48.6466 15.0375 48.1338 14.6836 47.9344 14.5459 47.7617 14.3733 47.624 14.1738 47.27 13.661 47.2695 12.9408 47.2695 11.5 47.2695 10.0589 47.27 9.3381 47.624 8.8252 47.7617 8.62578 47.9344 8.45308 48.1338 8.31543 48.6466 7.9615 49.3668 7.96094 50.8076 7.96094H55.2314V3.53809C55.2314 2.09765 55.2313 1.37709 55.585.864258 55.7226.664828 55.8963.492149 56.0957.354492 56.6086.000555366 57.3287 1.62347e-09 58.7695 0Z" fill="${color}"/>
  </svg>`,
  // LineFace - viewBox="0 0 82 8"
  (color: string) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 82 8" fill="none">
    <path d="M3.53125.164063C4.90133.164063 5.58673.163893 6.08301.485352 6.31917.638428 6.52075.840012 6.67383 1.07617 6.99555 1.57252 6.99512 2.25826 6.99512 3.62891 6.99512 4.99911 6.99536 5.68438 6.67383 6.18066 6.52075 6.41682 6.31917 6.61841 6.08301 6.77148 5.58672 7.09305 4.90147 7.09277 3.53125 7.09277 2.16062 7.09277 1.47486 7.09319.978516 6.77148.742356 6.61841.540772 6.41682.387695 6.18066.0662401 5.68439.0664063 4.999.0664063 3.62891.0664063 2.25838.0660571 1.57251.387695 1.07617.540772.840012.742356.638428.978516.485352 1.47485.163744 2.16076.164063 3.53125.164063Z" fill="${color}"/>
    <path d="M25.1836.164063C26.5542.164063 27.24.163638 27.7363.485352 27.9724.638384 28.1731.8401 28.3262 1.07617 28.6479 1.57252 28.6484 2.25825 28.6484 3.62891 28.6484 4.99931 28.6478 5.68436 28.3262 6.18066 28.1731 6.41678 27.9724 6.61842 27.7363 6.77148 27.24 7.09321 26.5542 7.09277 25.1836 7.09277H11.3262C9.95557 7.09277 9.26978 7.09317 8.77344 6.77148 8.53728 6.61841 8.33569 6.41682 8.18262 6.18066 7.86115 5.68438 7.86133 4.99902 7.86133 3.62891 7.86133 2.25835 7.86096 1.57251 8.18262 1.07617 8.33569.840012 8.53728.638428 8.77344.485352 9.26977.163768 9.95572.164063 11.3262.164063H25.1836Z" fill="${color}"/>
    <path d="M78.2034 7.09325C76.8333 7.09325 76.1479 7.09342 75.6516 6.77197 75.4155 6.61889 75.2139 6.4173 75.0608 6.18114 74.7391 5.6848 74.7395 4.99905 74.7395 3.62841 74.7395 2.2582 74.7393 1.57294 75.0608 1.07665 75.2139.840493 75.4155.638909 75.6516.485832 76.1479.164271 76.8332.164543 78.2034.164543 79.574.164543 80.2598.164122 80.7561.485832 80.9923.638909 81.1939.840493 81.347 1.07665 81.6684 1.57293 81.6682 2.25831 81.6682 3.62841 81.6682 4.99894 81.6686 5.68481 81.347 6.18114 81.1939 6.4173 80.9923 6.61889 80.7561 6.77197 80.2598 7.09357 79.5739 7.09325 78.2034 7.09325Z" fill="${color}"/>
    <path d="M56.5511 7.09325C55.1804 7.09325 54.4947 7.09368 53.9983 6.77197 53.7622 6.61893 53.5615 6.41722 53.4085 6.18114 53.0868 5.6848 53.0862 4.99907 53.0862 3.62841 53.0862 2.258 53.0868 1.57296 53.4085 1.07665 53.5615.840539 53.7622.638898 53.9983.485832 54.4947.164105 55.1804.164543 56.5511.164543H70.4085C71.7791.164543 72.4649.164146 72.9612.485832 73.1974.638909 73.399.840493 73.552 1.07665 73.8735 1.57293 73.8733 2.25829 73.8733 3.62841 73.8733 4.99896 73.8737 5.68481 73.552 6.18114 73.399 6.4173 73.1974 6.61889 72.9612 6.77197 72.4649 7.09355 71.7789 7.09325 70.4085 7.09325H56.5511Z" fill="${color}"/>
  </svg>`,
  // CurvedFace - viewBox="0 0 63 9"
  (color: string) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 63 9" fill="none">
    <path d="M0 5.06511C0 4.94513 0 4.88513.00771184 4.79757.0483059 4.33665.341025 3.76395.690821 3.46107.757274 3.40353.783996 3.38422.837439 3.34559 2.40699 2.21129 6.03888 0 10.5 0 14.9611 0 18.593 2.21129 20.1626 3.34559 20.216 3.38422 20.2427 3.40353 20.3092 3.46107 20.659 3.76395 20.9517 4.33665 20.9923 4.79757 21 4.88513 21 4.94513 21 5.06511 21 6.01683 21 6.4927 20.9657 6.6754 20.7241 7.96423 19.8033 8.55941 18.5289 8.25054 18.3483 8.20676 17.8198 7.96876 16.7627 7.49275 14.975 6.68767 12.7805 6 10.5 6 8.21954 6 6.02504 6.68767 4.23727 7.49275 3.18025 7.96876 2.65174 8.20676 2.47108 8.25054 1.19668 8.55941.275917 7.96423.0342566 6.6754 0 6.4927 0 6.01683 0 5.06511Z" fill="${color}"/>
    <path d="M42 5.06511C42 4.94513 42 4.88513 42.0077 4.79757 42.0483 4.33665 42.341 3.76395 42.6908 3.46107 42.7573 3.40353 42.784 3.38422 42.8374 3.34559 44.407 2.21129 48.0389 0 52.5 0 56.9611 0 60.593 2.21129 62.1626 3.34559 62.216 3.38422 62.2427 3.40353 62.3092 3.46107 62.659 3.76395 62.9517 4.33665 62.9923 4.79757 63 4.88513 63 4.94513 63 5.06511 63 6.01683 63 6.4927 62.9657 6.6754 62.7241 7.96423 61.8033 8.55941 60.5289 8.25054 60.3483 8.20676 59.8198 7.96876 58.7627 7.49275 56.975 6.68767 54.7805 6 52.5 6 50.2195 6 48.025 6.68767 46.2373 7.49275 45.1802 7.96876 44.6517 8.20676 44.4711 8.25054 43.1967 8.55941 42.2759 7.96423 42.0343 6.6754 42 6.4927 42 6.01683 42 5.06511Z" fill="${color}"/>
  </svg>`,
];

// Same colors the Facehash component uses by default
const DEFAULT_COLORS = [
  '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
  '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
  '#14b8a6', '#e879f9', '#22d3ee', '#a3e635', '#fb923c',
];

// Eye vertical positions from facehash SPHERE_POSITIONS
const EYE_Y_OFFSETS = [-1, 1, 0, 1, 0, 0, -1, -1, 1];

const SIZE = 128;

export function useFaceTexture(name: string): THREE.CanvasTexture | null {
  return useMemo(() => {
    if (typeof document === 'undefined' || !name) return null;

    // Use separate hashes for each property to avoid correlated selections
    const hashFace = stringHash(name + '_face');
    const hashColor = stringHash(name + '_color');
    const hashEyes = stringHash(name + '_eyes');
    const hashPos = stringHash(name + '_pos');

    const faceIndex = hashFace % FACE_SVGS.length;
    const bgColor = DEFAULT_COLORS[hashColor % DEFAULT_COLORS.length];
    const eyeColor = hashEyes % 2 === 0 ? '#ffffff' : '#000000';
    const eyeYOffset = EYE_Y_OFFSETS[hashPos % EYE_Y_OFFSETS.length];

    const svg = FACE_SVGS[faceIndex](eyeColor);

    const canvas = document.createElement('canvas');
    canvas.width = SIZE;
    canvas.height = SIZE;
    const ctx = canvas.getContext('2d')!;

    // Background
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, SIZE, SIZE);

    // Gradient overlay like facehash does
    const grad = ctx.createRadialGradient(SIZE / 2, SIZE / 2, 0, SIZE / 2, SIZE / 2, SIZE * 0.6);
    grad.addColorStop(0, 'rgba(255,255,255,0.15)');
    grad.addColorStop(1, 'transparent');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, SIZE, SIZE);

    // Draw face SVG onto canvas
    const img = new Image();
    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);

    const texture = new THREE.CanvasTexture(canvas);

    img.onload = () => {
      const eyeWidth = SIZE * 0.7;
      const eyeHeight = SIZE * 0.25;
      const x = (SIZE - eyeWidth) / 2;
      // Vary vertical position based on hash
      const baseY = SIZE * 0.35;
      const y = baseY + eyeYOffset * SIZE * 0.08;
      ctx.drawImage(img, x, y, eyeWidth, eyeHeight);

      // Draw initial letter below the eyes
      const initial = name.charAt(0).toUpperCase();
      ctx.fillStyle = eyeColor;
      ctx.font = `bold ${SIZE * 0.22}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(initial, SIZE / 2, SIZE * 0.78);

      URL.revokeObjectURL(url);
      texture.needsUpdate = true;
    };
    img.src = url;

    return texture;
  }, [name]);
}
